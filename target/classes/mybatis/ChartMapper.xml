<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ecdata.ec803.dao.ChartDao">

    <select id="queryCountGroupByScore" resultType="hashmap">

        SELECT GROUP_CONCAT(t2.psychology_score) "score",GROUP_CONCAT(t2.sum) "sum" FROM (
            SELECT psychology_score,sum(psychologyCount) "sum" from (
                SELECT psychology_score,count(*) "psychologyCount" FROM inquest_comment GROUP BY psychology_score
                UNION ALL
                SELECT voiceprint_score,count(*) "voiceprintCount" FROM inquest_comment GROUP BY voiceprint_score
                UNION ALL
                SELECT total_score,count(*) "totleCount" FROM inquest_comment GROUP BY total_score
            ) as t1
        group by t1.psychology_score ) t2
    </select>


    <select id="queryCountGroupByScoreAndPoliceOffice" resultType="hashmap">
        select GROUP_CONCAT(one) one,GROUP_CONCAT(two) two,GROUP_CONCAT(three) three,GROUP_CONCAT(four) four,GROUP_CONCAT(five) five,GROUP_CONCAT(police_office) policeOffice from (

        select SUM(case when t1.psychology_score = 1  then 1 else 0 end)+SUM(case when t1.voiceprint_score = 1  then 1 else 0 end)+
        SUM(case when t1.is_helpful_score = 1  then 1 else 0 end)+SUM(case when t1.total_score = 1  then 1 else 0 end) one,

        SUM(case when t1.psychology_score = 2  then 1 else 0 end)+SUM(case when t1.voiceprint_score = 2  then 1 else 0 end)+
        SUM(case when t1.is_helpful_score = 2  then 1 else 0 end)+SUM(case when t1.total_score = 2  then 1 else 0 end) two,

        SUM(case when t1.psychology_score = 3  then 1 else 0 end)+SUM(case when t1.voiceprint_score = 3  then 1 else 0 end)+
        SUM(case when t1.is_helpful_score = 3  then 1 else 0 end)+SUM(case when t1.total_score = 3  then 1 else 0 end) three,

        SUM(case when t1.psychology_score = 4  then 1 else 0 end)+SUM(case when t1.voiceprint_score = 4  then 1 else 0 end)+
        SUM(case when t1.is_helpful_score = 4  then 1 else 0 end)+SUM(case when t1.total_score = 4  then 1 else 0 end) four,

        SUM(case when t1.psychology_score = 5  then 1 else 0 end)+SUM(case when t1.voiceprint_score = 5  then 1 else 0 end)+
        SUM(case when t1.is_helpful_score = 5  then 1 else 0 end)+SUM(case when t1.total_score = 5  then 1 else 0 end) five
        ,t2.police_office from inquest_comment t1 left join feiq_record_info t2 on t1.inquest_id = t2.id

        group by police_office
        ) a
    </select>


    <select id="queryInquestAndCommentNumTrend" resultType="hashmap">

        select GROUP_CONCAT(b.time) time,GROUP_CONCAT(b.inquestNum) inquestNum,GROUP_CONCAT(b.commentNum) commentNum
        from (
        select (inquest_time) time,
        ifnull(max(
        CASE
        WHEN inquest='inquest' THEN
        IFNULL(count1,0)
        END
        ),0)
        inquestNum
        ,
        ifnull(
        max(
        CASE
        WHEN inquest='comment' THEN
        count1
        END
        ),0) commentNum
        from (
        select DATE_FORMAT(from_unixtime(SUBSTR(t1.createtime ,1,10)) ,'%Y-%m-%d') inquest_time,count(*)
        count1,"inquest" from feiq_record_info t1 where 1 = 1
        <if test="endTime != null">
            and t1.createtime &lt;= CONCAT(unix_timestamp(#{endTime}),'000')
        </if>
        <if test="beginTime != null">
            and t1.createtime &gt;= CONCAT(unix_timestamp(#{beginTime}),'000')
        </if>
        group by DATE_FORMAT(from_unixtime(SUBSTR(t1.createtime ,1,10)) ,'%Y-%m-%d')
        union all
        select DATE_FORMAT(t3.create_time ,'%Y-%m-%d') comment_time,count(*) count2,"comment" from inquest_comment t3
        group by DATE_FORMAT(t3.create_time ,'%Y-%m-%d')
        ) a
        GROUP BY a.inquest_time
        order by a.inquest_time
        ) b
    </select>


    <select id="queryInquestAndCommentNumGroupByPoliceOffice" resultType="hashmap">
      select po1 policeOffice, inquestCount,commentCount from (
        select count(*) inquestCount,police_office po1 from feiq_record_info GROUP BY police_office
        )a
        left join
        (
        select  count(*) commentCount,t2.police_office po2 from inquest_comment t1 left join feiq_record_info t2 on t1.inquest_id =  t2.id
        where t2.police_office is not null
        group by t2.police_office
        )b
      on a.po1 =b.po2
    </select>





    <select id="query" resultType="java.util.LinkedHashMap">
        SELECT GROUP_CONCAT(incount), GROUP_CONCAT(reccount)
            , GROUP_CONCAT(police)
        FROM (
                 SELECT incount, reccount, p2 AS police
                 FROM (
                          SELECT ifnull(incount, 0) AS incount, ptemp1.police_office AS p1
                          FROM (
                                   SELECT ifnull(COUNT(*), 0) AS incount, police_office AS p1
                                   FROM inquest_comment a
                                       LEFT JOIN feiq_record_info b ON a.inquest_id = b.id
                                   GROUP BY police_office
                               ) inq_temp
                              RIGHT JOIN (
                                             SELECT police_office
                                             FROM feiq_record_info
                                             WHERE id != ''
                                             GROUP BY police_office
                                         ) ptemp1
                                  ON inq_temp.p1 = ptemp1.police_office
                      ) c
                     RIGHT JOIN (
                                    SELECT ifnull(reccount, 0) AS reccount, ptemp2.police_office AS p2
                                    FROM (
                                             SELECT ifnull(COUNT(*), 0) AS reccount, police_office AS p2
                                             FROM feiq_record_info
                                             WHERE id != ''
                                             GROUP BY police_office
                                         ) rec_temp
                                        RIGHT JOIN (
                                                       SELECT police_office
                                                       FROM feiq_record_info
                                                       WHERE id != ''
                                                       GROUP BY police_office
                                                   ) ptemp2
                                            ON rec_temp.p2 = ptemp2.police_office
                                ) d
                         ON p1 = p2
                 WHERE p1 IS NOT NULL
                       AND p2 IS NOT NULL
             ) e
    </select>


    <select id="rightop" resultType="hashmap">
        select GROUP_CONCAT(inquest) inquest,
        GROUP_CONCAT(record) record,GROUP_CONCAT(redays) days from(
        select * from(
          select count(*) inquest,DATE_FORMAT(i.update_time,'%Y-%m-%d') indays
          from inquest_comment i
          where DATE_SUB(CURDATE(),INTERVAL 7 DAY)&lt;=date(i.update_time) group by indays) inpart
        right join (
          select count(*) record ,DATE_FORMAT(from_unixtime(substr(f.createTime,1,10)),'%Y-%m-%d')
        redays from feiq_record_info f
        where DATE_SUB(CURDATE(),INTERVAL 7 DAY)&lt;=date(from_unixtime(substr(f.createTime,1,10)))
        group by redays)repart on inpart.indays=repart.redays) inre
    </select>


    <select id="rightopInquest" resultType="hashmap">
        select count(*) inquest,DATE_FORMAT(i.update_time,'%Y-%m-%d') indays from inquest_comment i
        where  1=1
        <choose>
            <when test="begin!=null and begin!='' and end!=null and end!=''">
                and date(i.update_time) between #{begin} and #{end}
            </when>
            <otherwise>
          <!--      and DATE_SUB(CURDATE(),INTERVAL 7 DAY)&lt;=date(i.update_time) -->
            </otherwise>
        </choose>
        group by indays
    </select>

    <select id="rightopRecord" resultType="hashmap">
        select count(*) record ,DATE_FORMAT(from_unixtime(substr(f.createTime,1,10)),'%Y-%m-%d') redays
        from feiq_record_info f
        where  1=1
        <choose>
            <when test="begin!=null and begin!='' and end!=null and end!=''">
                and date(from_unixtime(substr(f.createTime,1,10))) between #{begin} and #{end}
            </when>
            <otherwise>
                and DATE_SUB(CURDATE(),INTERVAL 7 DAY)&lt;=date(from_unixtime(substr(f.createTime,1,10)))
            </otherwise>
        </choose>
        group by redays
    </select>




    <select id="pie" resultType="hashmap">

        select
        SUM(case when t1.psychology_score = 1  then 1 else 0 end)+SUM(case when t1.voiceprint_score = 1  then 1 else 0 end)+
        SUM(case when t1.is_helpful_score = 1  then 1 else 0 end)+SUM(case when t1.total_score = 1  then 1 else 0 end) 一星,

        SUM(case when t1.psychology_score = 2  then 1 else 0 end)+SUM(case when t1.voiceprint_score = 2  then 1 else 0 end)+
        SUM(case when t1.is_helpful_score = 2  then 1 else 0 end)+SUM(case when t1.total_score = 2  then 1 else 0 end) 二星,

        SUM(case when t1.psychology_score = 3  then 1 else 0 end)+SUM(case when t1.voiceprint_score = 3  then 1 else 0 end)+
        SUM(case when t1.is_helpful_score = 3  then 1 else 0 end)+SUM(case when t1.total_score = 3  then 1 else 0 end) 三星,

        SUM(case when t1.psychology_score = 4  then 1 else 0 end)+SUM(case when t1.voiceprint_score = 4  then 1 else 0 end)+
        SUM(case when t1.is_helpful_score = 4  then 1 else 0 end)+SUM(case when t1.total_score = 4  then 1 else 0 end) 四星,

        SUM(case when t1.psychology_score = 5  then 1 else 0 end)+SUM(case when t1.voiceprint_score = 5  then 1 else 0 end)+
        SUM(case when t1.is_helpful_score = 5  then 1 else 0 end)+SUM(case when t1.total_score = 5  then 1 else 0 end) 五星
        ,t2.police_office police from inquest_comment t1 left join
        feiq_record_info t2 on t1.inquest_id = t2.id
        where  1=1
        <choose>
            <when test="begin!=null and begin!='' and end!=null and end!=''">
                and date(t1.update_time) between #{begin} and #{end}
            </when>
            <otherwise>
           <!--     and 1=1 -->
            </otherwise>
        </choose>
         and t2.police_office is not null

        group by t2.police_office
    </select>

    <select id="getPolice" resultType="hashmap">
        select police_office police from feiq_record_info where police_office is not null
        GROUP BY police_office
    </select>

    <select id="pieAll" resultType="hashmap">
        select  SUM(case when t1.psychology_score = 1  then 1 else 0 end) + SUM(case when t1.voiceprint_score = 1  then 1 else 0 end) +
         SUM(case when t1.is_helpful_score = 1  then 1 else 0 end) + SUM(case when t1.total_score = 1  then 1 else 0 end)  一星,

         SUM(case when t1.psychology_score = 2  then 1 else 0 end) + SUM(case when t1.voiceprint_score = 2  then 1 else 0 end) +
         SUM(case when t1.is_helpful_score = 2  then 1 else 0 end) + SUM(case when t1.total_score = 2  then 1 else 0 end)  二星,

         SUM(case when t1.psychology_score = 3  then 1 else 0 end) + SUM(case when t1.voiceprint_score = 3  then 1 else 0 end) +
         SUM(case when t1.is_helpful_score = 3  then 1 else 0 end) + SUM(case when t1.total_score = 3  then 1 else 0 end)  三星,

         SUM(case when t1.psychology_score = 4  then 1 else 0 end) + SUM(case when t1.voiceprint_score = 4  then 1 else 0 end) +
         SUM(case when t1.is_helpful_score = 4  then 1 else 0 end) + SUM(case when t1.total_score = 4  then 1 else 0 end)  四星,

         SUM(case when t1.psychology_score = 5  then 1 else 0 end) + SUM(case when t1.voiceprint_score = 5  then 1 else 0 end) +
         SUM(case when t1.is_helpful_score = 5  then 1 else 0 end) + SUM(case when t1.total_score = 5  then 1 else 0 end)  五星
        from inquest_comment t1 left join feiq_record_info t2 on t1.inquest_id = t2.id
        where 1=1
        <choose>
        <when test="begin!=null and begin!='' and end!=null and end!=''">
            and date(t1.update_time) between #{begin} and #{end}
        </when>
            <otherwise>
                and 1=1
            </otherwise>
        </choose>
        and t2.police_office is not null
    </select>

    <select id="radar" resultType="java.util.LinkedHashMap" parameterType="String">
        select IFNULL(avg(i.psychology_score),0) '心理波动分析准确度',
        IFNULL(avg(i.voiceprint_score),0) '声纹情绪分析准确度',IFNULL(avg(i.total_score),0) '系统评价',
        IFNULL(avg(i.is_helpful_score),0) '侦控信息查询作用评价'
            from inquest_comment i left join feiq_record_info f on i.inquest_id = f.id
        where 1=1
        <choose>
            <when test="begin!=null and begin!='' and end!=null and end!=''">
                and date(i.update_time) between #{begin} and #{end}
            </when>
            <otherwise>
--                 and DATE_SUB(CURDATE(),INTERVAL 7 DAY)&lt;=date(i.update_time)
            </otherwise>
        </choose>


    </select>


    <select id="inqDashbord" resultType="java.util.LinkedHashMap">

        select count(1) '批注/评估总数' from inquest_comment i left join feiq_record_info f on
           i.inquest_id=f.id where i.create_time is not null and f.police_office is not null
          and f.createTime is not null and i.inquest_id is not null and f.id is not null

    </select>

    <select id="recDashbord" resultType="java.util.LinkedHashMap">
        select count(1) '审讯记录总数' from feiq_record_info f where f.police_office is not null
            and f.createTime is not null and f.id is not null
    </select>

    <select id="queryInquestAndCommentNum" parameterType="hashmap" resultType="hashmap">
        select t1.police_office policeOffice,t1.inquestNum,t2.commentNum from
        (select police_office,count(*) inquestNum from feiq_record_info  where 1 = 1
        <if test="begin !=null">
            and createTime &gt;= #{begin}
        </if>
        <if test="end !=null">
            and createTime &lt;= #{end}
        </if>
        group by police_office ) t1
        left join
        (
        select bb.police_office,sum(if(commentNum>0,1,0)) commentNum from(
        select u.police_office,(ic.id)+(select count(*) from inquest_comment_sub icb left join feq_lattice fl on fl.id = icb.lattice_id where fl.sid = u.id) commentNum
        from feiq_record_info u   left join  inquest_comment ic ON u.id = ic.inquest_id  where 1=1
        <if test="begin !=null">
            and createTime &gt;= #{begin}
        </if>
        <if test="end !=null">
            and createTime &lt;= #{end}
        </if>
        group by u.id
        ) bb group by bb.police_office
        )t2
        on t1.police_office = t2.police_office
        order by policeOffice
    </select>


    <select id="querySystemScore" parameterType="hashmap" resultType="hashmap">
        select SUM(case when t1.is_helpful_score = 1  then 1 else 0 end) one,
        SUM(case when t1.is_helpful_score = 2  then 1 else 0 end) two,
        SUM(case when t1.is_helpful_score = 3  then 1 else 0 end) three,
        SUM(case when t1.is_helpful_score = 4  then 1 else 0 end) four,
        SUM(case when t1.is_helpful_score = 5  then 1 else 0 end) five
        ,t2.police_office policeOffice from inquest_comment t1 left join feiq_record_info t2 on t1.inquest_id = t2.id
        <if test="begin !=null">
            and createTime &gt;= #{begin}
        </if>
        <if test="end !=null">
            and createTime &lt;= #{end}
        </if>
        group by police_office order by police_office

    </select>


    <select id="queryInquestSubScore" parameterType="hashmap" resultType="hashmap">
        select SUM(case when t1.voiceprint_accuracy = 1  then 1 else 0 end) voiceprintOne,
                SUM(case when t1.voiceprint_accuracy = 2  then 1 else 0 end) voiceprintTwo,
                SUM(case when t1.voiceprint_accuracy = 3  then 1 else 0 end) voiceprintThree,
                SUM(case when t1.voiceprint_accuracy = 4  then 1 else 0 end) voiceprintFour,
                SUM(case when t1.voiceprint_accuracy = 5  then 1 else 0 end) voiceprintFive,
                SUM(case when t1.psychology_accuracy = 1  then 1 else 0 end) psychologyOne,
                SUM(case when t1.psychology_accuracy = 2  then 1 else 0 end) psychologyTwo,
                SUM(case when t1.psychology_accuracy = 3  then 1 else 0 end) psychologyThree,
                SUM(case when t1.psychology_accuracy = 4  then 1 else 0 end) psychologyFour,
                SUM(case when t1.psychology_accuracy = 5  then 1 else 0 end) psychologyFive,
                SUM(case when t1.system_accuracy = 1  then 1 else 0 end) systemOne,
                SUM(case when t1.system_accuracy = 2  then 1 else 0 end) systemTwo,
                SUM(case when t1.system_accuracy = 3  then 1 else 0 end) systemThree,
                SUM(case when t1.system_accuracy = 4  then 1 else 0 end) systemFour,
                SUM(case when t1.system_accuracy = 5  then 1 else 0 end) systemFive
                ,t3.police_office policeOffice
        from inquest_comment_sub t1 left join feq_lattice t2 on t1.lattice_id = t2.id
        left join feiq_record_info t3 on t2.sid = t3.id
        where 1 = 1
        <if test="begin !=null">
            and t3.createTime &gt;= #{begin}
        </if>
        <if test="end !=null">
            and t3.createTime &lt;= #{end}
        </if>
        group by police_office order by police_office
    </select>






    <select id="selectForstatisticsTable" parameterType="string" resultType="map">
        SELECT
        police_office,
        count( t3.police_office ) useNum,
        count( t3.inquest_id ) evaluateNum,
        GROUP_CONCAT( t3.inquest_id ) sidList,
        sum( CASE WHEN t3.psychology_score = 2 THEN 1 ELSE 0 END ) psychologyScore2,
        sum( CASE WHEN t3.psychology_score = 1 THEN 1 ELSE 0 END ) psychologyScore1,
        sum( CASE WHEN t3.psychology_score = 0 THEN 1 ELSE 0 END ) psychologyScore0,
        sum( CASE WHEN t3.voiceprint_score = 2 THEN 1 ELSE 0 END ) voiceprintScore2,
        sum( CASE WHEN t3.voiceprint_score = 1 THEN 1 ELSE 0 END ) voiceprintScore1,
        sum( CASE WHEN t3.voiceprint_score = 0 THEN 1 ELSE 0 END ) voiceprintScore0,
        sum( CASE WHEN t3.reliability_score = 2 THEN 1 ELSE 0 END ) reliabilityScore2,
        sum( CASE WHEN t3.reliability_score = 1 THEN 1 ELSE 0 END ) reliabilityScore1,
        sum( CASE WHEN t3.reliability_score = 0 THEN 1 ELSE 0 END ) reliabilityScore0,
        sum( CASE WHEN t3.query_module_score = 2 THEN 1 ELSE 0 END ) queryModuleScore2,
        sum( CASE WHEN t3.query_module_score = 1 THEN 1 ELSE 0 END ) queryModuleScore1,
        sum( CASE WHEN t3.query_module_score = 0 THEN 1 ELSE 0 END ) queryModuleScore0,
        sum( CASE WHEN t3.equipment_usability_score = 2 THEN 1 ELSE 0 END ) equipmentUsabilityScore2,
        sum( CASE WHEN t3.equipment_usability_score = 1 THEN 1 ELSE 0 END ) equipmentUsabilityScore1,
        sum( CASE WHEN t3.equipment_usability_score = 0 THEN 1 ELSE 0 END ) equipmentUsabilityScore0
        FROM
        (
        SELECT
        t1.police_office,
        t2.inquest_id,
        t2.psychology_score,
        t2.voiceprint_score,
        t2.reliability_score,
        t2.query_module_score,
        t2.equipment_usability_score
        FROM
        feiq_record_info t1
        LEFT JOIN inquest_comment t2 ON t1.id = t2.inquest_id
        WHERE
        1 = 1
        <if test="begin != null and begin !=''">
            and t1.createTime >= #{begin}
        </if>
        <if test="end != null and end !=''">
            and  #{end} >= t1.createTime
        </if>
        ) t3
        GROUP BY
        t3.police_office
    </select>

    <select id="queryAllAverageScore" resultType="java.util.Map" parameterType="java.util.List">
        select ROUND(sum(t2.voiceprint_accuracy)/count(1),2) voiceprintAverage,
        ROUND(sum(t2.psychology_accuracy)/count(1),2) psychologyAverage
        from feq_lattice t1
        inner join inquest_comment_sub  t2
        on t1.id = t2.lattice_id
        where
        t1.sid in
        <foreach collection="sidList" open="(" item="sid" close=")" separator=",">
            #{sid}
        </foreach>
        and t1.spk = 1
    </select>

</mapper>
